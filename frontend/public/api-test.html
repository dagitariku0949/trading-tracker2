<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0f172a;
            color: white;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-slate-900 text-white p-6">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-center">üîß API Diagnostic Tool</h1>
            
            <div class="bg-slate-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Environment Info</h2>
                <div class="space-y-2 text-sm font-mono">
                    <div>Current URL: <span id="currentUrl" class="text-green-400"></span></div>
                    <div>API Base URL: <span id="apiBaseUrl" class="text-green-400"></span></div>
                    <div>Test Time: <span id="testTime" class="text-green-400"></span></div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">API Test Results</h2>
                    <button onclick="testAPI()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                        üîÑ Test API
                    </button>
                </div>
                <div id="testResults" class="space-y-4">
                    <div class="text-gray-400">Click "Test API" to run diagnostics...</div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-xl font-bold mb-4">Raw API Response</h2>
                <pre id="rawResponse" class="bg-slate-900 p-4 rounded text-sm overflow-auto max-h-96 text-gray-300">
No data yet...
                </pre>
            </div>

            <div class="text-center mt-6">
                <button onclick="window.location.href='/'" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg mr-3">
                    üè† Back to Website
                </button>
                <button onclick="window.location.href='/admin-panel'" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg">
                    üëë Admin Panel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize page
        document.getElementById('currentUrl').textContent = window.location.origin;
        document.getElementById('apiBaseUrl').textContent = window.location.origin + '/api/learning';
        document.getElementById('testTime').textContent = new Date().toISOString();

        async function testAPI() {
            const resultsDiv = document.getElementById('testResults');
            const rawResponseDiv = document.getElementById('rawResponse');
            
            resultsDiv.innerHTML = '<div class="text-yellow-400">üîÑ Testing API...</div>';
            rawResponseDiv.textContent = 'Testing...';

            const tests = [];
            const apiUrl = window.location.origin + '/api/learning';

            // Test 1: Basic API call
            try {
                const startTime = Date.now();
                const response = await fetch(apiUrl + '?v=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                tests.push({
                    name: 'API Connectivity',
                    status: response.ok ? 'success' : 'error',
                    message: `HTTP ${response.status} - ${responseTime}ms`,
                    details: `Response time: ${responseTime}ms`
                });

                if (response.ok) {
                    const data = await response.json();
                    rawResponseDiv.textContent = JSON.stringify(data, null, 2);

                    // Test 2: Data structure validation
                    if (data.success && data.data) {
                        tests.push({
                            name: 'Data Structure',
                            status: 'success',
                            message: 'Valid API response structure',
                            details: `Courses: ${data.data.courses?.length || 0}, Videos: ${data.data.videos?.length || 0}`
                        });

                        // Test 3: Content validation
                        const courseCount = data.data.courses?.length || 0;
                        tests.push({
                            name: 'Content Validation',
                            status: courseCount >= 3 ? 'success' : 'warning',
                            message: `Found ${courseCount} courses`,
                            details: courseCount >= 3 ? 'Expected course count met' : 'Expected at least 3 courses'
                        });
                    } else {
                        tests.push({
                            name: 'Data Structure',
                            status: 'error',
                            message: 'Invalid API response structure',
                            details: 'Missing success flag or data object'
                        });
                    }
                } else {
                    rawResponseDiv.textContent = `HTTP ${response.status}: ${response.statusText}`;
                    tests.push({
                        name: 'API Response',
                        status: 'error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        details: 'API call failed'
                    });
                }
            } catch (error) {
                tests.push({
                    name: 'API Connectivity',
                    status: 'error',
                    message: 'Network error: ' + error.message,
                    details: 'Failed to connect to API endpoint'
                });
                rawResponseDiv.textContent = 'Error: ' + error.message;
            }

            // Test 4: CORS check
            try {
                const corsResponse = await fetch(apiUrl, {
                    method: 'OPTIONS'
                });
                tests.push({
                    name: 'CORS Configuration',
                    status: corsResponse.ok ? 'success' : 'warning',
                    message: `OPTIONS request: HTTP ${corsResponse.status}`,
                    details: 'CORS preflight check'
                });
            } catch (error) {
                tests.push({
                    name: 'CORS Configuration',
                    status: 'error',
                    message: 'CORS check failed: ' + error.message,
                    details: 'Possible CORS configuration issue'
                });
            }

            // Display results
            resultsDiv.innerHTML = tests.map(test => `
                <div class="flex items-center space-x-3 p-3 rounded ${
                    test.status === 'success' ? 'bg-green-900 border border-green-700' :
                    test.status === 'warning' ? 'bg-yellow-900 border border-yellow-700' :
                    'bg-red-900 border border-red-700'
                }">
                    <div class="text-2xl">
                        ${test.status === 'success' ? '‚úÖ' : test.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold">${test.name}</div>
                        <div class="text-sm opacity-90">${test.message}</div>
                        <div class="text-xs opacity-70">${test.details}</div>
                    </div>
                </div>
            `).join('');

            // Update test time
            document.getElementById('testTime').textContent = new Date().toISOString();
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            setTimeout(testAPI, 1000);
        });
    </script>
</body>
</html>